{% extends "base.html" %}
{% block content %}
<div class="container-xl py-4">
  <div class="card shadow-lg border-0 rounded-4 bg-light">
    <div class="card-body">
      <div class="d-flex align-items-center mb-4">
        <i class="fas fa-clock fa-2x text-primary me-3"></i>
        <h2 class="mb-0 fw-bold">Rozliczenie czasu pracy</h2>
      </div>
      <form method="get" class="row g-3 align-items-end mb-4">
        <div class="col-sm-4">
          <label class="form-label fw-semibold" for="start_date">
            <i class="fas fa-calendar-alt me-1"></i> Data od:
          </label>
          <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
        </div>
        <div class="col-sm-4">
          <label class="form-label fw-semibold" for="end_date">
            <i class="fas fa-calendar-alt me-1"></i> Data do:
          </label>
          <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
        </div>
        <div class="col-sm-4 d-grid">
          <button type="submit" class="btn btn-primary btn-lg shadow">
            <i class="fas fa-search me-2"></i> Pokaż
          </button>
        </div>
      </form>
      <div class="table-responsive rounded-3 shadow-sm">
        <table class="table table-hover align-middle mb-0 bg-white" id="hoursTable" style="min-width:1200px;">
          <thead class="sticky-top bg-primary text-white">
            <tr>
              <th class="text-center" onclick="sortTable(0)">Kod PR</th>
              <th onclick="sortTable(1)">Imię</th>
              <th onclick="sortTable(2)">Nazwisko</th>
              <th onclick="sortTable(3)">START</th>
              <th onclick="sortTable(4)">Przerwa</th>
              <th onclick="sortTable(5)">STOP</th>
              <th onclick="sortTable(6)">Praca na akord</th>
              <th onclick="sortTable(7)">Praca na godziny</th>
              <th onclick="sortTable(8)">Suma czasu pracy</th>
              {% for field in fields %}
                <th onclick="sortTable({{ 9 + loop.index0 }})">{{ field.name }}</th>
              {% endfor %}
              <th onclick="sortTable({{ 9 + fields|length }})">Sztuki razem</th>
              <th onclick="sortTable({{ 10 + fields|length }})">Razem waga</th>
              <th onclick="sortTable({{ 11 + fields|length }})">Płaca za akord</th>
              <th onclick="sortTable({{ 12 + fields|length }})">Płaca za godzinę</th>
              <th onclick="sortTable({{ 13 + fields|length }})">Wynagrodzenie brutto</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
            <tr>
              <td class="text-center fw-bold">{{ row.kod_pr }}</td>
              <td>{{ row.imie }}</td>
              <td>{{ row.nazwisko }}</td>
              <td>{{ row.start }}</td>
              <td>{{ row.przerwa }}</td>
              <td>{{ row.stop }}</td>
              <td class="text-end">{{ row.praca_akord }}</td>
              <td class="text-end">{{ row.praca_godziny }}</td>
              <td>{{ row.suma_czasu }}</td>
              {% for field in fields %}
                <td class="text-end">{{ row.field_weights[field.name]|round(2) }}</td>
              {% endfor %}
              <td class="text-end">{{ row.sztuki_razem }}</td>
              <td class="text-end">{{ row.razem_waga }}</td>
              <td class="text-end text-success">{{ row.placa_akord }}</td>
              <td class="text-end text-primary">{{ row.placa_godziny }}</td>
              <td class="text-end fw-bold text-dark">{{ row.wynagrodzenie_brutto }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="bg-light fw-bold">
              <td colspan="6" class="text-end">SUMA:</td>
              <td class="text-end" id="sum_praca_akord">0.00</td>
              <td class="text-end" id="sum_praca_godziny">0.00</td>
              <td></td>
              {% for field in fields %}
                <td class="text-end" id="sum_field_{{ loop.index0 }}">0.00</td>
              {% endfor %}
              <td class="text-end" id="sum_sztuki_razem">0.00</td>
              <td class="text-end" id="sum_razem_waga">0.00</td>
              <td class="text-end text-success" id="sum_placa_akord">0.00</td>
              <td class="text-end text-primary" id="sum_placa_godziny">0.00</td>
              <td class="text-end fw-bold text-dark" id="sum_wynagrodzenie_brutto">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
// --- SORTOWANIE TABELI ---
function sortTable(n) {
    var table = document.getElementById("hoursTable");
    var tbody = table.tBodies[0];
    var rows = Array.from(tbody.rows);
    var asc = table.getAttribute('data-sort-col') != n || table.getAttribute('data-sort-dir') != 'asc';
    rows.sort(function(a, b) {
        let cellA = a.cells[n].innerText.replace(",", ".").replace(" PLN", "");
        let cellB = b.cells[n].innerText.replace(",", ".").replace(" PLN", "");
        let numA = parseFloat(cellA);
        let numB = parseFloat(cellB);
        if (!isNaN(numA) && !isNaN(numB)) {
            return asc ? numA - numB : numB - numA;
        }
        return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    rows.forEach(function(row) { tbody.appendChild(row); });
    table.setAttribute('data-sort-col', n);
    table.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
    sumTable();
}

// --- SUMY NA DOLE TABELI ---
function sumTable() {
    var table = document.getElementById("hoursTable");
    var tbody = table.tBodies[0];
    var rows = Array.from(tbody.rows);
    // Indeksy kolumn (dostosuj jeśli zmienisz kolejność!)
    const idx_praca_akord = 6;
    const idx_praca_godziny = 7;
    // fieldy dynamicznie:
    const fields_count = {{ fields|length }};
    const idx_field_first = 9;
    const idx_field_last = idx_field_first + fields_count - 1;
    const idx_sztuki_razem = idx_field_last + 1;
    const idx_razem_waga = idx_field_last + 2;
    const idx_placa_akord = idx_field_last + 3;
    const idx_placa_godziny = idx_field_last + 4;
    const idx_wynagrodzenie_brutto = idx_field_last + 5;

    let sum_praca_akord = 0, sum_praca_godziny = 0;
    let sum_field = Array(fields_count).fill(0);
    let sum_sztuki_razem = 0, sum_razem_waga = 0;
    let sum_placa_akord = 0, sum_placa_godziny = 0, sum_wynagrodzenie_brutto = 0;

    rows.forEach(function(row) {
        sum_praca_akord += parseFloat(row.cells[idx_praca_akord].innerText.replace(",", ".") || 0);
        sum_praca_godziny += parseFloat(row.cells[idx_praca_godziny].innerText.replace(",", ".") || 0);
        for (let i = 0; i < fields_count; i++) {
            sum_field[i] += parseFloat(row.cells[idx_field_first + i].innerText.replace(",", ".") || 0);
        }
        sum_sztuki_razem += parseFloat(row.cells[idx_sztuki_razem].innerText.replace(",", ".") || 0);
        sum_razem_waga += parseFloat(row.cells[idx_razem_waga].innerText.replace(",", ".") || 0);
        sum_placa_akord += parseFloat(row.cells[idx_placa_akord].innerText.replace(",", ".") || 0);
        sum_placa_godziny += parseFloat(row.cells[idx_placa_godziny].innerText.replace(",", ".") || 0);
        sum_wynagrodzenie_brutto += parseFloat(row.cells[idx_wynagrodzenie_brutto].innerText.replace(",", ".") || 0);
    });
    document.getElementById("sum_praca_akord").innerText = sum_praca_akord.toFixed(2);
    document.getElementById("sum_praca_godziny").innerText = sum_praca_godziny.toFixed(2);
    for (let i = 0; i < fields_count; i++) {
        document.getElementById("sum_field_" + i).innerText = sum_field[i].toFixed(2);
    }
    document.getElementById("sum_sztuki_razem").innerText = sum_sztuki_razem.toFixed(2);
    document.getElementById("sum_razem_waga").innerText = sum_razem_waga.toFixed(2);
    document.getElementById("sum_placa_akord").innerText = sum_placa_akord.toFixed(2);
    document.getElementById("sum_placa_godziny").innerText = sum_placa_godziny.toFixed(2);
    document.getElementById("sum_wynagrodzenie_brutto").innerText = sum_wynagrodzenie_brutto.toFixed(2);
}
// Wywołaj sumowanie po załadowaniu
window.addEventListener('DOMContentLoaded', sumTable);
</script>
{% endblock %}